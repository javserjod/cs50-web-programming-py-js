{% extends "quiz/layout.html" %}

{% block body %}

<div class="container mt-5 border pt-5 pb-3 shadow-lg rounded">
            
    <div class="scoreboard">
        {% for round in rounds %}
            {% if round.number is game.current_round.number %}
                <a href="{% url 'game_update' game.id %}" class="round-score-box blinker">{{ round.number }}</a>
            {% else %}
                {% if round.state == 'CORRECT' %}
                    <a href="{% url 'game_round_details' game.id round.number %}" class="round-score-box correct">{{ round.number }}</a>
                {% elif round.state == 'WRONG' %}
                    <a href="{% url 'game_round_details' game.id round.number %}" class="round-score-box wrong">{{ round.number }}</a>
                {% else %}
                    <div class="round-score-box blocked">{{ round.number }}</div>
                {% endif %}
            {% endif %}
        {% endfor %}
    </div>
    
    {% if not round_detailed %}
        <div class="text-center mb-4">
            <div class="container d-flex justify-content-between align-items-center mb-4 p-0" style="width:400px">
                
                {% with game.current_round.number|add:"-1" as prev_round_number %}
                    {% if prev_round_number < 1 %}
                        <button class="btn btn-secondary" style="height: 38px; padding: 6px 12px; visibility: hidden;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" onclick=window.location.href="{% url 'game_round_details' game.id prev_round_number %}" style="height: 38px; padding: 6px 12px;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    {% endif %}
                {% endwith %}

                <h2>Round {{ game.current_round.number }}</h2>
                
                <button class="btn btn-secondary" style="height: 38px; padding: 6px 12px; visibility: hidden;">
                    <i class="bi bi-arrow-right"></i>
                </button>
                
            </div>

            <div class="mb-4 rounded">
                <img src="{{ modified_image }}" alt="Modified image" class=" img-fluid rounded shadow-lg" id="image-to-guess" style="width: 400px; height: auto;">
            </div>

            <div class="mb-3">
                <!-- Buttons -->
                <div class="d-flex justify-content-center gap-2 mb-3">
                    <form id="skipButtonForm" action="{% url 'skip_round' game.id %}" method="post" style="margin:0;">
                        {% csrf_token %}
                        <button class="btn btn-secondary" type="submit" id="skipButton" style="height: 38px; padding: 6px 12px;">
                            Skip
                        </button>
                    </form>

                    <button class="btn btn-primary" type="submit" style="height: 38px; padding: 6px 12px;" form="guessImageForm" id="submitGuessButton">
                        Submit
                    </button>
                </div>

                <!-- Text Input and Selector -->
                <form id="guessImageForm" method="post" style="max-width: 400px; margin: 0 auto;" action="{% url 'game_update' game.id %}">
                    {% csrf_token %}
                    <div class="position-relative">

                        {% if game.mode == 'Cover Image' %}
                            <input type="text" class="form-control" placeholder="Enter your answer here" id="guessCoverInput" name="user_input" required autocomplete="off" style="width: 100%;" data-game-source="{{ game.source }}">
                        {% elif game.mode == 'Character Image' %}
                            <input type="text" class="form-control" placeholder="Enter the character's name here" id="guessCharacterInput" name="user_input" required autocomplete="off" style="width: 100%;">
                        {% endif %}

                        <div id="suggestions" class="suggestion-box"></div>
                    
                    </div>
                </form>
            </div>
        </div>

    {% else %}
        <div class="text-center mb-4">
            <div class="container d-flex justify-content-between align-items-center mb-4 p-0" style="width:400px">
                
                {% with round_detailed.number|add:"-1" as prev_round_number %}
                    {% if prev_round_number < 1 %}
                        <button class="btn btn-secondary" style="height: 38px; padding: 6px 12px; visibility: hidden;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" onclick=window.location.href="{% url 'game_round_details' game.id prev_round_number %}" style="height: 38px; padding: 6px 12px;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    {% endif %}
                {% endwith %}

                <h2>Round {{ round_detailed.number }}</h2>
                
                {% with round_detailed.number|add:"1" as next_round_number %}
                    {% if next_round_number > game.n_questions %}
                        <button class="btn btn-secondary" style="height: 38px; padding: 6px 12px; visibility: hidden;">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" onclick=window.location.href="{% url 'game_round_details' game.id next_round_number %}" style="height: 38px; padding: 6px 12px;">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    {% endif %}
                {% endwith %}

            </div>
            
            <div id="image-alternate-container" class="mb-4 rounded" style="cursor: pointer; display: inline-block; min-height: 500px;" data-round-state="{{ round_detailed.state }}">
                <img src="{{ image_url }}" alt="Original image" class="img-fluid rounded shadow-lg fade-in" id="image-original" style="width: 400px; height: auto;">

                <img src="{{ modified_image }}" alt="Modified image" class="img-fluid rounded shadow-lg hidden" id="image-modified" style="width: 400px; height: auto;">
            </div>

            <div class="mb-3" id="round-answer-data-container" data-round-db-id="{{ round_detailed.db_entry_id }}" data-game-mode="{{ game.mode }}">

                {% if round_detailed.state == 'CORRECT' %}
                    <p style="font-size: 2.5rem; font-weight: bold;" class="text-success mb-1" id="round-answer">
                        {{ round_detailed.correct_answer }}
                    </p>
                
                {% elif round_detailed.state == 'WRONG' %}
                    {% if round_detailed.user_answer %}
                        <p class="lead text-danger">Your answer: {{ round_detailed.user_answer }}</p>
                    {% else %}
                        <p class="lead text-danger">You skipped the round</p>
                    {% endif %}

                    <p class="lead text-muted mb-1">Correct answer was: </p>
                    <p style="font-size: 2.5rem; font-weight: bold;" id="round-answer">
                        {{ round_detailed.correct_answer }}
                    </p>
                {% endif %}
                
                <div id="fetched-data-container">
                    <em id="other-name" style="font-size: 1.7rem;"></em>
                    
                    <div id="round-details-container"></div>

                    <div id="character-participations" class="d-flex flex-wrap justify-content-center mt-5 gap-3 mx-auto" style="max-width:750px"></div>
                </div>
                    

            </div>
        </div>

        
    {% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const image = document.getElementById("image-original");

        if (image.complete) {
            image.classList.add("visible");
        } else {
            image.addEventListener("load", function () {
                image.classList.add("visible");
            });
        }
    });
</script>
    

</div>

{% endblock %}